# Data Model: AKS Deployment Automation

**Date**: 2025-12-07  
**Feature**: 001-aks-deployment-automation  
**Phase**: 1 - Design & Contracts

## Overview

This feature focuses on infrastructure and deployment automation rather than application data entities. The "data model" in this context represents the infrastructure resources, their relationships, and state management.

## Infrastructure Entities

### 1. Azure Resource Group

**Entity**: `azurerm_resource_group.main`

**Attributes**:
- `name`: "rg-sb-aks-01" (fixed per requirement)
- `location`: "centralindia" (fixed per requirement)
- `tags`: Map<string, string>
  - Environment: "production"
  - Project: "Tailspin"
  - ManagedBy: "Terraform"
  - Owner: TBD
  - CostCenter: TBD

**Relationships**:
- Contains: AKS cluster, ACR, VNet, Log Analytics workspace

**Lifecycle**:
- Created: First Terraform apply
- Updated: Tag changes only
- Deleted: Manual intervention required (safety)

---

### 2. AKS Cluster

**Entity**: `azurerm_kubernetes_cluster.aks`

**Attributes**:
- `name`: "aks-tailspin-prod"
- `location`: "centralindia"
- `dns_prefix`: "tailspin"
- `sku_tier`: "Standard"
- `automatic_upgrade_channel`: "stable"
- `kubernetes_version`: Latest stable (Azure-managed)

**Node Pool Configuration**:
- `name`: "systempool"
- `vm_size`: "Standard_DS2_v2"
- `auto_scaling_enabled`: true
- `min_count`: 1
- `max_count`: 3
- `vnet_subnet_id`: Reference to AKS subnet

**Identity**:
- `type`: "SystemAssigned" (managed identity)
- `principal_id`: Generated by Azure
- `tenant_id`: Azure tenant

**API Server Access**:
- `authorized_ip_ranges`: [] (public cluster)

**Relationships**:
- Resides in: Resource Group
- Uses: VNet subnet
- Authenticated to: ACR (via role assignment)
- Monitored by: Log Analytics workspace

**Lifecycle**:
- Created: Terraform apply (12-15 minutes)
- Updated: Node pool scaling, version upgrades
- Deleted: Terraform destroy (manual approval required)

**State Transitions**:
1. Provisioning → Running
2. Running → Upgrading → Running
3. Running → Scaling → Running

**Validation Rules**:
- Location must be "centralindia"
- Public cluster (no private endpoint)
- System-assigned managed identity required
- Auto-scaling enabled with min >= 1

---

### 3. Azure Container Registry (ACR)

**Entity**: `azurerm_container_registry.acr`

**Attributes**:
- `name`: "acrtailspin" (must be globally unique)
- `location`: "centralindia"
- `sku`: "Premium" (required for vulnerability scanning)
- `admin_enabled`: false (use managed identity)

**Repositories**:
- `tailspin-server`: Flask backend images
- `tailspin-client`: Astro frontend images

**Image Tags**:
- Format: `{semantic-version}-{git-sha}` (e.g., "v1.0.0-abc123f")
- `latest`: Points to most recent push

**Relationships**:
- Resides in: Resource Group
- Accessed by: AKS cluster (AcrPull role)
- Populated by: GitHub Actions (Docker build workflow)

**Lifecycle**:
- Created: Terraform apply (2-3 minutes)
- Updated: Image pushes (out-of-band)
- Deleted: Terraform destroy (manual approval required)

**Validation Rules**:
- Premium SKU required for vulnerability scanning
- Admin access disabled (RBAC only)
- Name must be lowercase, alphanumeric

---

### 4. Virtual Network

**Entity**: `azurerm_virtual_network.vnet`

**Attributes**:
- `name`: "vnet-tailspin-prod"
- `location`: "centralindia"
- `address_space`: ["10.0.0.0/16"]

**Subnets**:
- **AKS Subnet**:
  - `name`: "snet-aks"
  - `address_prefix`: "10.0.1.0/24"
  - Used by: AKS node pool

**Relationships**:
- Resides in: Resource Group
- Used by: AKS cluster

**Lifecycle**:
- Created: Terraform apply (1-2 minutes)
- Updated: Subnet additions (future environments)
- Deleted: Terraform destroy

**Validation Rules**:
- CIDR blocks must not overlap with existing VNets
- AKS subnet must have sufficient IP addresses (min /24)

---

### 5. Log Analytics Workspace

**Entity**: `azurerm_log_analytics_workspace.logs`

**Attributes**:
- `name`: "log-tailspin-prod"
- `location`: "centralindia"
- `sku`: "PerGB2018"
- `retention_in_days`: 30

**Relationships**:
- Resides in: Resource Group
- Collects logs from: AKS cluster, Application Insights

**Lifecycle**:
- Created: Terraform apply (1-2 minutes)
- Updated: Retention period changes
- Deleted: Terraform destroy

---

### 6. Application Insights

**Entity**: `azurerm_application_insights.appinsights`

**Attributes**:
- `name`: "appi-tailspin-prod"
- `location`: "centralindia"
- `application_type`: "web"
- `workspace_id`: Reference to Log Analytics

**Outputs**:
- `instrumentation_key`: Used by application for telemetry
- `connection_string`: Used by application SDK

**Relationships**:
- Resides in: Resource Group
- Stores data in: Log Analytics workspace
- Used by: Tailspin server and client applications

**Lifecycle**:
- Created: Terraform apply (1-2 minutes)
- Updated: Configuration changes
- Deleted: Terraform destroy

---

### 7. Role Assignments (RBAC)

**Entity**: `azurerm_role_assignment.aks_acr_pull`

**Attributes**:
- `scope`: ACR resource ID
- `role_definition_name`: "AcrPull"
- `principal_id`: AKS kubelet managed identity

**Relationships**:
- Grants: AKS cluster access to ACR
- Required for: Image pulls without secrets

**Lifecycle**:
- Created: After AKS and ACR exist (Terraform dependency)
- Updated: Rarely (role changes)
- Deleted: Terraform destroy

**Validation Rules**:
- AKS managed identity must exist before assignment
- Role must be AcrPull (read-only)

---

## Kubernetes Entities

### 8. Namespace

**Entity**: Kubernetes Namespace `tail-spin`

**Attributes**:
- `name`: "tail-spin"
- `labels`:
  - app: "tailspin"
  - managed-by: "github-actions"

**Relationships**:
- Contains: Server and client deployments, services

**Lifecycle**:
- Created: kubectl apply (namespace.yaml)
- Updated: Label changes
- Deleted: Manual kubectl delete

---

### 9. Server Deployment

**Entity**: Kubernetes Deployment `tailspin-server`

**Attributes**:
- `namespace`: "tail-spin"
- `replicas`: 2
- `image`: ACR image with commit SHA tag
- `resources`:
  - requests: { cpu: "250m", memory: "512Mi" }
  - limits: { cpu: "1000m", memory: "1Gi" }

**Probes**:
- `livenessProbe`: GET /health on port 5000
- `readinessProbe`: GET /ready on port 5000

**Relationships**:
- Runs in: Namespace tail-spin
- Pulls image from: ACR
- Exposes: Service on port 5000

**Lifecycle**:
- Created: kubectl apply
- Updated: Image tag changes trigger rolling update
- Rolled back: kubectl rollout undo

**State Transitions**:
1. Pending → ContainerCreating → Running
2. Running → Terminating → Pending (rolling update)

---

### 10. Client Deployment

**Entity**: Kubernetes Deployment `tailspin-client`

**Attributes**:
- `namespace`: "tail-spin"
- `replicas`: 2
- `image`: ACR image with commit SHA tag
- `resources`:
  - requests: { cpu: "100m", memory: "256Mi" }
  - limits: { cpu: "500m", memory: "512Mi" }

**Probes**:
- `livenessProbe`: GET / on port 4321
- `readinessProbe`: GET / on port 4321

**Relationships**:
- Runs in: Namespace tail-spin
- Pulls image from: ACR
- Exposes: Service on port 4321
- Accessed by: Client LoadBalancer service

---

### 11. Client LoadBalancer Service

**Entity**: Kubernetes Service `tailspin-client-lb`

**Attributes**:
- `namespace`: "tail-spin"
- `type`: "LoadBalancer"
- `selector`: { app: "tailspin-client" }
- `ports`:
  - port: 80
  - targetPort: 4321

**External Access**:
- `loadBalancerIP`: Assigned by Azure (dynamic)
- `externalIPs`: Public IP address for client access

**Relationships**:
- Routes traffic to: Client deployment pods
- Provisioned by: Azure Load Balancer

**Lifecycle**:
- Created: kubectl apply
- Updated: Port or selector changes
- Deleted: kubectl delete

---

## State Management

### Terraform State

**Storage**: Azure Storage Account
- Account: "sttailspintfstate"
- Container: "tfstate"
- Blob: "tailspin-aks.tfstate"

**State Structure**:
```json
{
  "version": 4,
  "terraform_version": "1.6.0",
  "resources": [
    {
      "type": "azurerm_resource_group",
      "name": "main",
      "instances": [...]
    },
    {
      "type": "azurerm_kubernetes_cluster",
      "name": "aks",
      "instances": [...],
      "dependencies": ["azurerm_resource_group.main", "azurerm_subnet.aks"]
    }
    // ... other resources
  ]
}
```

**State Locking**:
- Mechanism: Azure Storage blob lease
- Timeout: 15 minutes
- Lock ID: Unique UUID per operation

---

## Infrastructure Relationships Diagram

```
Resource Group (rg-sb-aks-01)
├── Virtual Network (vnet-tailspin-prod)
│   └── Subnet (snet-aks)
│       └── [Used by AKS nodes]
│
├── AKS Cluster (aks-tailspin-prod)
│   ├── System Node Pool (auto-scaling 1-3 nodes)
│   ├── Managed Identity (SystemAssigned)
│   │   └── [Role: AcrPull on ACR]
│   └── Kubernetes Resources
│       └── Namespace (tail-spin)
│           ├── Deployment (tailspin-server) [replicas: 2]
│           ├── Deployment (tailspin-client) [replicas: 2]
│           └── Service (tailspin-client-lb) [type: LoadBalancer]
│
├── Container Registry (acrtailspin)
│   ├── Repository: tailspin-server
│   │   └── Images: v1.0.0-abc123f, latest
│   └── Repository: tailspin-client
│       └── Images: v1.0.0-abc123f, latest
│
├── Log Analytics Workspace (log-tailspin-prod)
│   └── [Collects logs from AKS, Application Insights]
│
└── Application Insights (appi-tailspin-prod)
    └── [Monitors server and client applications]
```

---

## Validation Rules Summary

**Infrastructure**:
- All resources must be in "centralindia" region
- All resources must be in "rg-sb-aks-01" resource group
- All resources must have required tags (Environment, Project, ManagedBy)
- AKS cluster must be public (no private endpoint)
- ACR must be Premium SKU with admin access disabled
- Managed identities preferred over service principals

**Kubernetes**:
- All deployments must specify resource requests and limits
- All deployments must have liveness and readiness probes
- Image tags must include commit SHA for traceability
- Namespace must be "tail-spin"
- Client service must be type LoadBalancer for external access

**Security**:
- No hardcoded credentials in Terraform or Kubernetes manifests
- No image pull secrets (use managed identity)
- Vulnerability scanning must pass before image push
- RBAC roles must follow least privilege principle

---

## Future Enhancements

1. **Multi-Environment Support**: Extend data model with environment parameter (dev, staging, prod)
2. **Horizontal Pod Autoscaler**: Add HPA entities for automatic pod scaling
3. **Persistent Volumes**: Add PVC/PV entities if stateful workloads required
4. **Ingress Controller**: Replace LoadBalancer with Ingress for advanced routing
5. **Azure Key Vault Integration**: Add Key Vault entity for secrets management
